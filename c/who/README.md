# 文件的读写  
# 知识点
这一章介绍了在Unix下开发的通常流程。具体如下：  
1. 使用`man`查找相关命令的手册。  
2. 根据手册中的描述找到相关的头文件。  
3. 在头文件中找到与之相关的数据结构。  
4. 根据要实现的功能构思程序基本流程，并列举可能用到的系统功能。  
5. 使用`man -k <keyword>`根据需要的功能查找系统调用。  
6. 使用系统调用编写程序，此过程中可能需要上网搜索其他资料。  
7. 比较实现的程序与系统自带程序的输出结果。  
8. 如结果不同，则需要再次查阅手册以及相关头文件，在头文件中寻找进一步信息。否则，进一步考虑如何提高程序性能。  
9. 提高性能时需进一步理解相关概念，掌握常用的方法。  
10. 得到一个功能正确，性能基本可以的程序，完成开发。  
## 功能分析  
要编写的who程序应该具有以下的功能：  
1. 能够读取相应的文件，并将结果显示出来。  
2. 显示的结果中只应该包含对应真实的用户的记录，并且能够正确地展示时间。  
3. 利用缓冲提高程序的性能。  
4. 编写注销函数，使其能正确修改相应的文件。注销之后，who可以正确地展示变化后的文件内容。  
5. 能够正确地处理系统调用可能产生的错误。  
6. 提供额外的接口，可以检查utmp文件内容的变化，展示utmp记录的所有字段，并且可以通过参数指定要读取的文件，进而用其检查wtmp的内容。  

## 编程中的问题  
1. read和fread 
第一个问题是既然要读文件，那么`read`和`fread`有什么区别，应该使用哪一个？搜索后发现，读文件实际上可能涉及到两层缓冲。第一层是用户程序设置的缓冲，作用是减少系统调用的次数。第二层缓冲是内核使用的缓冲，它一般会把磁盘上的文件放到内存中内核的缓冲区进行缓存。作为系统调用的`read`只有内核层的缓冲，而作为标准函数的`fread`还具有用户空间的缓冲。  
*read在NFS文件系统上，连续读取少量数据，只会在第一次更新文件的时间戳。因为大多数NFS系统会将更新访问时间的任务留给服务器端，而客户端从客户的缓存中读入后就会返回。Unix下可以禁止客户端的缓存，但这样会极大增加服务器的负荷。*
